# n8n Docker Setup - Architecture Documentation

## Overview

This repository creates a **secure, self-hosted n8n workflow automation platform** on a VPS (Hostinger) using Docker and Tailscale for private networking. The setup uses a **"sidecar pattern"** where each service pairs with a Tailscale container to create a private network overlay, making services accessible only through your Tailscale VPN.

---

## Architecture & Setup Flow

### Initial Setup (`prep.sh`)

The `prep.sh` script bootstraps your entire server:

#### Creates a Non-Root User
- Sets up a new sudo user with SSH key authentication
- Hardens SSH security (disables password auth, disables root login)
- Configures zsh shell with basic aliases

#### Generates Secure Secrets
- Creates random passwords/keys for Postgres, MeiliSearch, NextAuth, SearXNG, and OpenWebUI
- Stores these in environment files automatically

#### Domain Configuration
- Takes your domain name and replaces all `mydomain.com` references throughout config files
- Sets up Caddyfile with your custom subdomains (n.yourdomain.com, s.yourdomain.com, etc.)

#### File Permissions
- Moves the repo to the new user's home directory
- Creates `~/.config` directory for Tailscale auth key

---

## Service Architecture

Each service uses **two containers**:

1. **Application container** - The actual service (n8n, Postgres, etc.)
2. **Tailscale sidecar** - Provides VPN connectivity with a unique hostname

They share networking via `network_mode: service:<tailscale-container>`, creating private access.

---

## Service Details

### 1. n8n (Workflow Automation Platform)

**Purpose:** The core application - n8n is a workflow automation tool (similar to Zapier/Make)

**Containers:** 
- `n8n` - Main application
- `n8n-on-hstgr` - Tailscale sidecar

**Network:**
- Hostname: `n8n-on-hstgr` on Tailscale network
- Public access: Via `n.yourdomain.com` (through Caddy reverse proxy)
- Port: 5678

**Storage:**
- Persistent volume for workflows/credentials
- `./local_files` mounted for file operations

**Key Features:**
- Requires authentication (built-in n8n auth)
- HTTPS protocol enforced
- Webhook support enabled
- Environment variables control timezone, diagnostics, version notifications

**Configuration:**
```
N8N_HOST=n.yourdomain.com
N8N_PROTOCOL=https
WEBHOOK_URL=https://n.yourdomain.com/
GENERIC_TIMEZONE=Europe/London
```

---

### 2. Caddy (Reverse Proxy & SSL)

**Purpose:** Acts as the gateway - handles HTTPS certificates, routes traffic to services

**Container:** Single `caddy` container (no Tailscale sidecar needed)

**Custom Build:** Built with Cloudflare DNS plugin for automatic SSL certificate generation
```dockerfile
RUN xcaddy build \
    --with github.com/caddy-dns/cloudflare
```

**Exposed Ports:**
- 80 (HTTP)
- 443 (HTTPS)
- 443/UDP (HTTP/3)

**Routes:**
- `n.yourdomain.com` → n8n (port 5678)
- `s.yourdomain.com` → SearXNG (port 8080, DNS challenge)
- `kk.yourdomain.com` → Karakeep (port 3000, DNS challenge)
- `pages.yourdomain.com` → Static file server with CORS headers

**Requirements:**
- Cloudflare API token for DNS challenge (automated SSL)
- Token stored in `.env` file as `CLOUDFLARE_API_TOKEN`

**Special Features:**
- OCSP stapling disabled for compatibility
- DNS challenges for services behind Tailscale
- Automatic certificate renewal
- File server with browse capability for static pages

**Note:** Only Caddy is directly exposed to the internet; all other services are accessed through it.

---

### 3. Postgres (Database)

**Purpose:** Database for persistent storage (used by n8n for workflow/execution data)

**Containers:**
- `db` - PostgreSQL 16+ database
- `pg-on-hstgr` - Tailscale sidecar

**Network:**
- Hostname: `pg-on-hstgr` on Tailscale network
- Access: Only accessible via Tailscale VPN (not exposed to internet)

**Storage:**
- `./postgres-data` - Database files
- `/dev/shm` - Shared memory (128MB tmpfs)

**Configuration:**
```
POSTGRES_PASSWORD=<auto-generated>
POSTGRES_DB=main
```

**Performance:**
- 128MB shared memory for query optimization
- Persistent data storage
- Automatic restart policy

---

### 4. Redis (Valkey - Redis Fork)

**Purpose:** In-memory cache/message broker (used for n8n queue mode, caching, or session storage)

**Containers:**
- `redis` - Valkey v8 Alpine
- `redis-on-hstgr` - Tailscale sidecar

**Network:**
- Hostname: `redis-on-hstgr` on Tailscale network
- Access: Only via Tailscale VPN

**Features:**
- Uses Valkey (Redis fork) v8
- Auto-saves every 30 seconds if 1+ key changed
- Minimal logging (1MB max, 1 file) to reduce disk usage
- Persistent volume storage

**Configuration:**
```bash
command: valkey-server --save 30 1 --loglevel warning
```

---

### 5. SearXNG (Meta Search Engine)

**Purpose:** Privacy-focused meta search engine that aggregates results from multiple search engines

**Containers:**
- `searxng` - Search application
- `searxng-on-hstgr` - Tailscale sidecar

**Network:**
- Hostname: `searxng-on-hstgr` on Tailscale network
- Public access: Via `s.yourdomain.com` (protected by Tailscale DNS challenge)
- Port: 8080

**Configuration:**
- Custom `settings.yml` with secret key for encryption
- Config directory mounted read-only for security
- Auto-generated secret key during setup

**Special Capabilities:**
- `SETGID`, `SETUID`, `DAC_OVERRIDE`, `CHOWN` for user management

**Use Case:**
- Can be integrated into n8n workflows for web searches without tracking
- Privacy-preserving search functionality

**Logging:**
- Limited to 1MB, 1 file for disk space management

---

### 6. Karakeep (AI-Powered Bookmark Manager)

**Purpose:** Intelligent bookmark/content management with AI tagging and search

**Containers:**
- `web` - Karakeep application
- `chrome` - Headless Chrome browser (Alpine-based)
- `meilisearch` - Fast search engine
- `karakeep-on-hstgr` - Tailscale sidecar

**Network:**
- Hostname: `karakeep-on-hstgr` on Tailscale network
- Public access: Via `kk.yourdomain.com` (protected)
- Port: 3000

**AI Features:**
- **Text Model:** `gemma3:12b` for text inference
- **Image Model:** `llava` for image analysis
- **Embedding Model:** `embeddinggemma:latest` for semantic search
- **Context Length:** 8096 tokens
- **Auto-tagging:** Enabled
- **Auto-summarization:** Enabled
- **Structured output:** JSON schema validation

**External Dependencies:**
- Connects to Ollama on your local machine via Tailscale (`http://localhost:11434`)
- Requires models to be pulled on local machine:
  - `ollama pull gemma3:12b`
  - `ollama pull llava`
  - `ollama pull embeddinggemma:latest`

**Internal Services:**
- **Chrome:** Headless browser for webpage snapshots
  - Remote debugging on port 9222
  - No sandbox mode for container compatibility
  - GPU disabled
- **MeiliSearch:** Fast search engine
  - Port 7700
  - Master key auto-generated
  - Analytics disabled for privacy
  - Persistent volume storage

**Configuration:**
```
OLLAMA_BASE_URL=http://localhost:11434
INFERENCE_TEXT_MODEL=gemma3:12b
INFERENCE_IMAGE_MODEL=llava
EMBEDDING_TEXT_MODEL=embeddinggemma:latest
INFERENCE_JOB_TIMEOUT_SEC=60
```

---

### 7. Open WebUI (Ollama Web Interface)

**Purpose:** Web interface for interacting with Ollama LLMs (Large Language Models)

**Containers:**
- `openwebui` - Web application
- `openwebui-on-hstgr` - Tailscale sidecar

**Network:**
- Hostname: `openwebui-on-hstgr` on Tailscale network
- Access: Only via Tailscale VPN (not publicly exposed via Caddy)

**Storage:**
- Persistent volume for chat history and configurations

**Features:**
- Chat interface for AI models
- Connects to your local Ollama instance through Tailscale
- Model management
- Conversation history

**Configuration:**
```
WEBUI_SECRET_KEY=<auto-generated>
OLLAMA_BASE_URL=<points to local Ollama via Tailscale>
```

**Note:** This service is intentionally not exposed through Caddy for additional security.

---

### 8. Watchtower (Automatic Updates)

**Purpose:** Automatically updates all Docker containers to their latest versions

**Container:** Single `watchtower` container (no Tailscale needed)

**Schedule:** Runs daily at 4:00 AM (configurable timezone)

**Features:**
- Monitors all running containers
- Pulls latest images from registries
- Recreates containers with new images
- Cleans up old images (`WATCHTOWER_CLEANUP=true`)
- Zero downtime updates

**Configuration:**
```
WATCHTOWER_CLEANUP=true
TZ=Europe/London
WATCHTOWER_SCHEDULE=0 0 4 * * *
```

**Access:** No network exposure (only monitors Docker daemon via socket)

**Cron Format:** `0 0 4 * * *` = 4:00 AM every day

---

## Security Model

### Tailscale VPN Layer

- All services except Caddy are **only accessible via Tailscale VPN**
- Each service gets a unique Tailscale hostname (e.g., `n8n-on-hstgr`, `pg-on-hstgr`)
- Uses a reusable auth key stored in `~/.config/tsauthkey`
- Requires `/dev/net/tun` device and `net_admin` capability for VPN networking
- State stored in service-specific directories for persistence

**Tailscale Configuration:**
```yaml
environment:
  - TS_EXTRA_ARGS=--auth-key file:/run/secrets/tsauthkey
  - TS_STATE_DIR=/var/lib/tailscale
  - TS_USERSPACE=false
devices:
  - /dev/net/tun:/dev/net/tun
cap_add:
  - net_admin
```

### Hostinger Firewall

- Configured to **DROP all traffic by default**
- Only allows HTTPS (443) and SSH (22)
- All other services hidden behind Tailscale

**Firewall Rules:**
1. Default: DROP
2. Allow: HTTPS (443)
3. Allow: SSH (22)
4. Source: Any (but only these ports open)

### SSH Hardening

Applied by `prep.sh`:
- ❌ No password authentication
- ❌ No root login
- ✅ Key-based authentication only
- ❌ PAM disabled to prevent bypass
- ✅ Cloud-init overrides removed

**SSH Config Changes:**
```
PasswordAuthentication no
PermitRootLogin no
UsePAM no
```

### SSL/TLS

- Automatic HTTPS via Caddy + Cloudflare DNS challenge
- No need to open port 80 for ACME challenges
- DNS-01 challenge allows SSL for services behind VPN
- Automatic certificate renewal
- HTTP/3 support enabled

---

## Network Flow

```
Internet → Caddy (443) → Tailscale Network → Service Containers
                ↓
         DNS Challenge (Cloudflare)
         
Your Local Machine (Tailscale) → All Services (direct VPN access)
                                → Ollama (used by Karakeep/OpenWebUI)
```

### Public Routes (Through Caddy)

| Domain | Service | Auth | Purpose |
|--------|---------|------|---------|
| `n.yourdomain.com` | n8n | n8n built-in | Workflow automation |
| `s.yourdomain.com` | SearXNG | DNS challenge | Privacy search |
| `kk.yourdomain.com` | Karakeep | NextAuth | AI bookmarks |
| `pages.yourdomain.com` | Static files | None | File hosting |

### Private Routes (Tailscale Only)

| Hostname | Service | Port | Purpose |
|----------|---------|------|---------|
| `pg-on-hstgr` | Postgres | 5432 | Database |
| `redis-on-hstgr` | Redis | 6379 | Cache/Queue |
| `openwebui-on-hstgr` | OpenWebUI | 8080 | LLM Chat |
| `n8n-on-hstgr` | n8n | 5678 | Direct access |
| `searxng-on-hstgr` | SearXNG | 8080 | Direct access |
| `karakeep-on-hstgr` | Karakeep | 3000 | Direct access |

---

## Data Persistence

### Volume Mounts

| Service | Volume | Purpose |
|---------|--------|---------|
| n8n | `n8n_storage` | Workflows, credentials, settings |
| n8n | `./local_files` | File operations |
| Postgres | `./postgres-data` | Database files |
| Redis | `valkey-data2` | Persistent cache |
| Caddy | `./data` | SSL certificates |
| Caddy | `./config` | Caddy configuration cache |
| Karakeep | `./data` | Bookmarks, snapshots |
| Karakeep | `meilisearch` | Search index |
| OpenWebUI | `open-webui` | Chat history |
| SearXNG | `./config` | Search settings (read-only) |

### Backup Considerations

**Critical Data:**
- n8n workflows: `n8n_storage` volume
- Postgres database: `postgres-data` directory
- SSL certificates: `caddy/data` directory
- Karakeep bookmarks: `karakeep/data` directory

**Regenerable Data:**
- Redis cache
- MeiliSearch index (can be rebuilt)
- Tailscale state (can reconnect)

---

## Environment Variables

### Auto-Generated Secrets

During `prep.sh` execution, the following are generated:

```bash
MEILI_MASTER_KEY=$(openssl rand -base64 36 | tr -dc 'A-Za-z0-9')
NEXTAUTH_SECRET=$(openssl rand -base64 36)
SEARXNG_SECRET=$(openssl rand -base64 36)
POSTGRES_PASSWORD=$(openssl rand -base64 36)
WEBUI_SECRET=$(openssl rand -base64 36)
```

### Manual Configuration Required

**Caddy:**
- `CLOUDFLARE_API_TOKEN` - Must be obtained from Cloudflare dashboard

**n8n:**
- `GENERIC_TIMEZONE` - Set to your timezone (e.g., `America/New_York`)

**Watchtower:**
- `TZ` - Set to your timezone for proper scheduling

**Karakeep:**
- `OLLAMA_BASE_URL` - Must point to your local Ollama instance via Tailscale

---

## Dependencies & Prerequisites

### External Services

1. **Domain Name** - You must own a domain
2. **Cloudflare Account** - For DNS management and SSL
3. **Hostinger VPS** - KVM2 plan recommended
4. **Tailscale Account** - Free plan sufficient
5. **Local Ollama** - For Karakeep and OpenWebUI AI features

### Local Machine Requirements

- Tailscale installed and connected to tailnet
- Ollama installed with models:
  - `gemma3:12b` (text generation)
  - `llava` (image analysis)
  - `embeddinggemma:latest` (embeddings)

### Server Requirements

- Ubuntu 20.04/22.04 (or compatible systemd-based Linux)
- Docker and Docker Compose installed
- Sufficient storage for volumes
- SSH access

---

## Why This Architecture?

### Security Benefits

1. **Minimal Attack Surface** - Only Caddy exposed to internet
2. **VPN-First Design** - Services isolated on private network
3. **Zero-Trust Networking** - Each service has unique Tailscale identity
4. **Automatic SSL** - No manual certificate management
5. **Hardened SSH** - Key-based auth only, no root access

### Operational Benefits

1. **Automatic Updates** - Watchtower keeps containers current
2. **Easy Access** - Tailscale provides simple access from anywhere
3. **Flexible Routing** - Caddy allows easy subdomain management
4. **Service Isolation** - Each service independent, can restart without affecting others
5. **Data Persistence** - Named volumes ensure data survives container recreation

### AI Integration Benefits

1. **Local AI Processing** - Ollama runs on your machine, not cloud
2. **Privacy Preserved** - No data sent to external AI services
3. **Model Flexibility** - Choose any Ollama-compatible model
4. **Cost Effective** - No per-token API charges

### Scalability

- Services can be scaled independently
- Easy to add new services following the same pattern
- Tailscale allows connecting multiple servers
- Can move services to different machines via Tailscale network

---

## Troubleshooting

### Service Not Accessible

1. Check if Tailscale sidecar is running: `docker ps | grep tailscale`
2. Verify Tailscale auth key is valid in `~/.config/tsauthkey`
3. Check if service appears in Tailscale admin panel
4. Test direct access via Tailscale hostname

### SSL Certificate Issues

1. Verify Cloudflare API token has correct permissions
2. Check Caddy logs: `docker logs caddy`
3. Ensure DNS records point to your server IP
4. Verify domain is using Cloudflare nameservers

### Ollama Connection Failed

1. Ensure local machine is connected to Tailscale
2. Verify Ollama is running: `ollama list`
3. Check Ollama is listening on all interfaces
4. Test connection from server: `curl http://<local-tailscale-ip>:11434`

### Database Connection Issues

1. Check Postgres is running: `docker ps | grep postgres`
2. Verify n8n can reach `pg-on-hstgr:5432`
3. Check Postgres logs: `docker logs <postgres-container>`
4. Ensure password in n8n matches Postgres `.env`

---

## Maintenance

### Regular Tasks

- **Daily:** Watchtower updates containers (automatic)
- **Weekly:** Check disk space: `df -h`
- **Monthly:** Review Tailscale devices, remove unused
- **Quarterly:** Update Ollama models: `ollama pull <model>`

### Manual Updates

**Update a specific service:**
```bash
cd ~/n8n-docker-setup/<service>
docker compose pull
docker compose up -d
```

**Rebuild Caddy (after config changes):**
```bash
cd ~/n8n-docker-setup/caddy
docker compose build --no-cache
docker compose up -d
```

### Backup Strategy

**Critical backups:**
```bash
# n8n workflows
docker run --rm -v n8n_storage:/data -v $(pwd):/backup \
  ubuntu tar czf /backup/n8n-backup.tar.gz /data

# Postgres database
docker exec <postgres-container> pg_dump -U postgres main > backup.sql

# Karakeep data
tar czf karakeep-backup.tar.gz karakeep/data
```

---

## Cost Analysis

### Server Costs

- **Hostinger VPS (KVM2):** ~$10-15/month
- **Domain Name:** ~$10-15/year
- **Cloudflare:** Free tier sufficient

### Free Services

- Tailscale: Free tier (up to 100 devices)
- Docker: Free
- All containerized services: Free

**Total Monthly Cost:** ~$10-15 (just VPS)

---

## Future Enhancements

### Potential Additions

- **Monitoring:** Grafana + Prometheus for metrics
- **Backups:** Automated backup service (e.g., Restic)
- **Load Balancing:** Multiple n8n instances for high availability
- **CI/CD:** Automated deployment pipeline
- **Additional AI Services:** Stable Diffusion, Whisper, etc.

### Scaling Considerations

- Add Redis cluster for high-availability caching
- Postgres replication for database redundancy
- Multiple Caddy instances behind load balancer
- Separate AI processing server with more GPU resources

---

## Conclusion

This architecture provides a **production-grade, security-first** setup for self-hosting n8n with integrated AI and search capabilities. The combination of Tailscale for private networking and Caddy for public SSL termination creates a secure yet accessible platform for workflow automation and AI-powered tools.

The modular design allows for easy maintenance, updates, and scaling while maintaining strong security boundaries between services and the public internet.
